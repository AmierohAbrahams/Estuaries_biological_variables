---
title: "Biomass_depth analysis"
author: "Amieroh, Kim and Yameen"
date: "20 June 2018"
output: html_document
---

```{r prelim_opts, echo=FALSE}
knitr::opts_chunk$set(
  comment = "R>",
  warning = FALSE,
  message = FALSE
)

library(tidyverse)
library(Hmisc)
library(corrplot)
library(ggplot2)
library(knitr)
library(tidyverse)
library(rmarkdown)
library(ggpubr)
library(ggmap)
library(dplyr)
library(ggpubr)
library(ggmap)
library(ggrepel)
library(plot3D)
```

A rough start

## Introduction:

Submerged macrophytes are aquatic plants with vegetative structures that are predominantly submerged and are integral to the ecological functioning of aquatic environments. They function as producers, are important sources of food and refuge, provide habitats for aquatic invertebrates, zooplankton and fish. In addition to this they alter water movement, sediment and nutrient dynamics. The distribution of macrophytes is determined by abiotic factors such as depth, nutrients, sediment type, pH and most importantly light. The submerged macrophyte, Isolepis, belongs to the sedge family Cyperaceae and consists of annuals and short-lived perennial plants having a grass-like appearance. Isolepis digitata is a tufted perennial with minute roots, ascending whitish rhizomes and green leaves. The genus Isolepis is well represented in South Africa with Isolepis digitata being endemic to the Cape region having its highest abundance in the winter months. It is found between Clanwilliam and Riversdale in the Western Cape in fast flowing streams, forming dense clusters on rock surfaces and flowers between September and January3. Very little is known about of this species, therefore this study focuses on Isolepis digitata and describes its morphology and the ecological role in relation to the environmental characteristics.

## Aim
To understand the role and autecology of Isolepis digitata along the Krom River.  The objectives are as follows:
To determine the effect of physical parameters on the morphology of Isolepis digitata. This will be done by assessing whether temperature, salinity and pH has an influence on the amount of rhizomes present or if these variables influence the biomass. To assess whether pH varies with depth.

## Methods 

## Field 
To determine the physical parameters influencing the distribution and abundance of Isolepis digitata, physical parameters including temperature (°C), pH, electrical conductivity (µS/cm), total dissolved solids (mg/l), salinity (PSU), dissolved O2 (mg/l) and O2 Saturation (%) was measured using a multi-parameter Aquaprobe at each point along the river where an Isolepis digitata sample was removed at each of the two sites.
A total of 10 samples were collected at each of the two sites, 10 from deep (21-36 cm) top section and 10 from shallow (10-20 cm) middle site water depths. Each Isolepis digitata sample that were present was removed from the bedrock using a 15cm scraper and was collected in a 300 x 300 mm SASS net having a mesh size of 1 mm. The contents of the SASS net were emptied into a plastic tray filled with 1/3 river water, making sure to remove any additional aquatic invertebrates still on the net into the tray. The aquatic invertebrates present on each Isolepis digitata sample was removed into the surrounding water in the plastic tray. Each Isolepis digitata sample was then removed from the plastic tray, placed in a ziplock bag filled with 1/3 river water and stored in the freezer until used in the laboratory. The remaining contents in the plastic tray were placed through a sieve in order to collect the aquatic invertebrates. The collected aquatic invertebrates were washed through a funnel into plastic containers with ethanol, making sure to fill the plastic containers with 1/3 ethanol. At the top site, 10 bedrock samples were also collected to compare the abundance of aquatic invertebrates present on the surrounding bedrock to the abundance present on Isolepis digitata.  
The aquatic invertebrates corresponding to each Isolepis digitata sample were further separated into individual eppendorf tubes filled with ethanol to be analysed at a later stage. 

## Laboratory 
After sample collection, the frozen Isolepis digitata samples were defrosted and laboratory experiments were conducted. The number of rhizomes, the culm length from the top of the soil to the tip of the plant for five culms and the number of spikelets were measured for each Isolepis digitata sample that was collected. All samples were placed in individual brown paper bags and were dried in the oven for a period of 4 days at 40°C. To determine the response of biomass to different environmental conditions, the total mass of each Isolepis digitata sample was recorded after the drying period and the below water mass was separated from the above water mass and was further weighed separately for each Isolepis digitata sample. 


## Statistical analyses

A correlation matrix was constructed using R statistical software to correlate each of the biological variables (number of rhizomes, culm length and total biomass) to each of the physical variables (temperature (°C), pH, electrical conductivity (µS/cm), total dissolved solids (mg/l), salinity (PSU), dissolved O2 (mg/l) and O2 Saturation (%)). A single factor ANOVA test was included to compare the biomass of samples at deep and shallow depths between sites....... we need to add more to this (A.A).

Themes for graphs
```{r}

theme_AJMS <- function(AfricanJournalOfMarineScience) {
  theme(
    panel.background = element_rect(fill = NA),
    panel.border = element_rect(size = 0.4, fill = NA),
    text = element_text(family = "Arial"),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    axis.title = element_text(size = 9),
    axis.ticks = element_line(size = 0.5),
    legend.position = "right",
    legend.direction = "vertical",
    legend.title = element_text(family = "Arial", size = 9),
    legend.text = element_text(family = "Arial", size = 9),
    legend.key = element_blank(),
    legend.key.height = unit(.3, "cm"),
    legend.box.spacing = unit(0.4, "cm"),
    legend.background = element_blank(),
    plot.title = element_text(size = 9, hjust = 0),
    strip.background = element_blank(),
    strip.text = element_text(size = 9),
    axis.ticks.length = unit(-0.2, "cm"),
    axis.text.x = element_text(margin = unit(c(0.25, 0.5, 0.5, 0.5), "cm"), vjust = 0.35, angle = 450),
    axis.text.y = element_text(margin = unit(c(0.5, 0.3, 0.5, 0.5), "cm"))
  )
}
```


Loading the data
```{r load_files1, include=TRUE}
R_assignment_AJ_ <- read_csv("R_assignment(AJ).csv")
Map_coordinates <- read_csv("Map_coordinates.csv")
load("~/Documents/R_assignment/south_africa_coast.RData")
load("~/Documents/R_assignment/sa_provinces.RData")
```


Possible code for mapping of the cederberg area (A.A)
```{r map_func, include=TRUE}
mapping_plot <- function(df){
  mapping <- df %>% 
ggplot(aes(x = lon, y = lat)) +
  geom_polygon(data = south_africa_coast, aes(group = group), fill = "grey70") +
  coord_cartesian(xlim = c(12, 36), ylim = c(-38, -26)) +
  geom_path(data = sa_provinces, aes(group = group)) +
  geom_point(data = df)  +
  geom_label_repel(data =df, aes(x = lon, y = lat, label = Site), 
                   size = 3, box.padding = 2, nudge_x = -0.5, nudge_y = 0.2, segment.alpha = 0.4) +
  theme(axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank())
  return(mapping)
}

map_1 <- mapping_plot(df = Map_coordinates)
map_1
```

Looking at biomass and site

```{r}
dat1 <- R_assignment_AJ_ %>% 
  group_by(Site) %>% 
  summarise(mn.pH = mean(pH),
            sd.pH = sd(pH))

plot_A <- ggplot(dat1, aes(x = Site, y = mn.pH)) +
  geom_col(aes(fill = Site)) +
  geom_errorbar(aes(ymin = mn.pH - sd.pH, 
                    ymax = mn.pH + sd.pH)) +
  labs(x = "Site", y = "Average pH") +
  theme_AJMS()

dat2 <- R_assignment_AJ_ %>% 
  group_by(Site) %>% 
  summarise(mn.Salinity = mean(Salinity),
            sd.Salinity = sd(Salinity))

plot_B <- ggplot(dat2, aes(x = Site, y = mn.Salinity)) +
  geom_col(aes(fill = Site)) +
  geom_errorbar(aes(ymin = mn.Salinity - sd.Salinity, 
                    ymax = mn.Salinity + sd.Salinity)) +
  labs(x = "Site", y = "Average Salinity") +
  theme_AJMS()

dat3 <- R_assignment_AJ_ %>% 
  group_by(Site) %>% 
  summarise(mn.Temperature = mean(Temperature),
            sd.Temperature = sd(Temperature))

plot_C <- ggplot(dat3, aes(x = Site, y = mn.Temperature)) +
  geom_col(aes(fill = Site)) +
  geom_errorbar(aes(ymin = mn.Temperature- sd.Temperature, 
                    ymax = mn.Temperature + sd.Temperature)) +
  labs(x = "Site", y = "Average Temperature") +
  theme_AJMS()

dat4 <- R_assignment_AJ_ %>% 
  group_by(Site) %>% 
  summarise(mn.Macbio = mean(Macrophyte_Biomass),
            sd.Macbio = sd(Macrophyte_Biomass))

plot_D <- ggplot(dat4, aes(x = Site, y = mn.Macbio)) +
  geom_col(aes(fill = Site)) +
  geom_errorbar(aes(ymin = mn.Macbio - sd.Macbio, 
                    ymax = mn.Macbio + sd.Macbio)) +
  labs(x = "Site", y = "Average Macrophyte") +
  theme_AJMS()


Final <- ggarrange(plot_A, plot_B,plot_C,plot_D,
                   ncol = 4, nrow = 1,
                   common.legend = TRUE)
Final
```



```{r}
# Comparing macrophyte_biomass and Depth
summary(R_assignment_AJ_$Macrophyte_Biomass)
data <- R_assignment_AJ_
data %>%
  summarise(min_t = min(Macrophyte_Biomass),
            quart_1 = quantile(Macrophyte_Biomass, 0.25),
            med_t = median(Macrophyte_Biomass),
            mean_t = mean(Macrophyte_Biomass),
            quart_3 = quantile(Macrophyte_Biomass, 0.75),
            max_t = max(Macrophyte_Biomass))

A <- ggplot(data, aes(x = Depth, y = Macrophyte_Biomass)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_AJMS()

# Comparing macrophyte biomass with tds
B <- ggplot(data, aes(x = TDS, y = Macrophyte_Biomass)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_AJMS()

combined <- ggarrange(A, B,
                   ncol = 2, nrow = 1,
                   common.legend = TRUE)
combined
```

```{r}
# Areas and adding trend
# Macrophyte Biomass
PLOT1 <- ggplot(data = R_assignment_AJ_, aes(y = Macrophyte_Biomass , x = Depth)) +
  geom_point(aes(colour = Site)) +
  geom_smooth(aes(colour = Site), method = "lm") +
  coord_equal(xlim = c(0, 60), ylim = c(0,60)) +
    theme_AJMS()
# Gray shade is the standard error
# angle of line shows the relationship


# Macrophyte biomass and TDS
PLOT2 <- ggplot(data = R_assignment_AJ_, aes(y = Macrophyte_Biomass , x = TDS)) +
  geom_point(aes(colour = Site)) +
  geom_smooth(aes(colour = Site), method = "lm") +
  coord_equal(xlim = c(0, 60), ylim = c(0,60)) +
    theme_AJMS()

combined1 <- ggarrange(PLOT1, PLOT2,
                   ncol = 2, nrow = 1,
                   common.legend = TRUE)
combined1
```





